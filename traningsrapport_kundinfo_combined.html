<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Träningsrapport – per kund</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Plotly + Papa -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: #f5f4f1;
            color: #2e2e2e;
        }

        .page {
            max-width: 1100px;
            margin: auto;
            padding: 3rem 2rem;
        }

        h1 {
            font-size: 2.4rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .control {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        select, input {
            padding: 0.6rem 0.7rem;
            font-family: inherit;
            border-radius: 6px;
            border: 1px solid #ccc;
            min-width: 180px;
        }

        .card {
            background: #ffffff;
            border-radius: 14px;
            padding: 2rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            margin-bottom: 2.5rem;
        }

        #chart {
            width: 100%;
            height: 500px;
        }

        #customer-info {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        #customer-info strong {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
<div class="page">

    <h1>Träningsrapport – välj kund</h1>

    <div class="controls">
        <div class="control">
            <label for="year-select">Välj år</label>
            <select id="year-select" onchange="updateChart()">
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
            </select>
        </div>

        <div class="control">
            <label for="kund-select">Sök kund</label>
            <input list="kundlista" id="kund-select" onchange="updateChart()" placeholder="Skriv t.ex. K0031">
            <datalist id="kundlista"></datalist>
        </div>
    </div>

    <div class="card">
        <div id="chart"></div>
    </div>

    <div class="card">
        <div id="customer-info"></div>
    </div>

</div>

<script>
    const besokUrl = "https://raw.githubusercontent.com/novia-linda/ai-kursen/refs/heads/main/besoksdata_medlemskap_med_passinfo.csv";
    const kundUrl = "https://raw.githubusercontent.com/novia-linda/ai-kursen/refs/heads/main/kundlista.csv";

    let allData = [];
    let kundinfo = new Map();

    Papa.parse(kundUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            results.data.forEach(row => {
                kundinfo.set(row.KundID, row);
                const opt = document.createElement("option");
                opt.value = row.KundID;
                document.getElementById("kundlista").appendChild(opt);
            });
            loadBesokData();
        }
    });

    function loadBesokData() {
        Papa.parse(besokUrl, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                allData = results.data;
                document.getElementById("kund-select").value = "K0001";
                updateChart();
            }
        });
    }

    function updateChart() {
        const kundID = document.getElementById("kund-select").value;
        const year = document.getElementById("year-select").value;

        const kundData = allData.filter(row =>
            row.KundID === kundID && row.Ar.toString() === year
        );
        if (kundData.length === 0) return;

        const gymMap = new Map();
        const passMap = new Map();

        kundData.forEach(row => {
            const key = row.Manadsnamn;
            const isPass = row.Besokstyp === "PASS";
            const mapToUse = isPass ? passMap : gymMap;
            mapToUse.set(key, (mapToUse.get(key) || 0) + 1);
        });

        const order = ["Januari","Februari","Mars","April","Maj","Juni",
                       "Juli","Augusti","September","Oktober","November","December"];

        let xLabels = Array.from(new Set([...gymMap.keys(), ...passMap.keys()]))
            .sort((a, b) => order.indexOf(a) - order.indexOf(b));

        const gymY = xLabels.map(x => gymMap.get(x) || 0);
        const passY = xLabels.map(x => passMap.get(x) || 0);

        const trace1 = { x: xLabels, y: gymY, type: 'bar', name: 'Gymbesök' };
        const trace2 = { x: xLabels, y: passY, type: 'bar', name: 'Ledd pass' };

        Plotly.newPlot("chart", [trace1, trace2], {
            barmode: 'group',
            title: `Månadsvy – Kund ${kundID}`,
            xaxis: { title: 'Månad' },
            yaxis: { title: 'Antal besök' }
        });

        const infoBox = document.getElementById("customer-info");
        const kundRow = kundinfo.get(kundID) || {};
        const total = kundData.length;
        const pass = kundData.filter(r => r.Besokstyp === "PASS").length;
        const gym = total - pass;

        const unikaPass = [...new Set(kundData.map(r => r.Passnamn).filter(Boolean))];
        const instruktorer = [...new Set(kundData.map(r => r.Instruktor).filter(Boolean))];

        infoBox.innerHTML = `
            <strong>Kundinformation (${year})</strong><br><br>
            Namn: ${kundRow.Namn || '–'}<br>
            Medlemskap: ${kundRow.Medlemskap || '–'}<br><br>
            Totalt antal besök: ${total}<br>
            Gymbesök: ${gym}<br>
            Ledd pass: ${pass}<br><br>
            <strong>Unika pass:</strong> ${unikaPass.join(", ") || "–"}<br>
            <strong>Instruktörer:</strong> ${instruktorer.join(", ") || "–"}
        `;
    }
</script>
</body>
</html>
